<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telestack Offline Persistence Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            padding: 2rem;
        }

        .card {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #334155;
            margin-bottom: 1rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-right: 0.5rem;
            transition: all 0.2s;
        }

        .primary {
            background: #3b82f6;
            color: white;
        }

        .danger {
            background: #ef4444;
            color: white;
        }

        .success {
            background: #10b981;
            color: white;
        }

        .status {
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-top: 1rem;
            display: inline-block;
        }

        .online {
            background: #064e3b;
            color: #34d399;
        }

        .offline {
            background: #7f1d1d;
            color: #f87171;
        }

        pre {
            background: #020617;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid #1e293b;
            color: #38bdf8;
        }
    </style>
</head>

<body>
    <h1>Telestack Persistence & Optimistic UI</h1>

    <div class="card">
        <h3>Connectivity State</h3>
        <button id="btnOnline" class="success">Force Online</button>
        <button id="btnOffline" class="danger">Force Offline</button>
        <span id="txtConnectivity" class="status online">ONLINE</span>
    </div>

    <div class="card">
        <h3>Document Snapshot</h3>
        <div id="docPath">Path: persistence-test/item-1</div>
        <pre id="docContent">Loading...</pre>
    </div>

    <div class="card">
        <h3>Actions</h3>
        <button id="btnIncrement" class="primary">Increment (Optimistic UI)</button>
        <button id="btnRefresh" class="primary">Refresh from Server</button>
    </div>

    <div id="logs" class="card">
        <h3>Logs</h3>
        <div id="logContent" style="font-size: 0.875rem; color: #94a3b8;"></div>
    </div>

    <script type="module">
        import { TelestackClient } from './dist/telestack-sdk.js';

        const ENDPOINT = 'http://localhost:8787';
        const DEAD_ENDPOINT = 'http://localhost:1234'; // Simulated timeout

        let client = new TelestackClient({
            endpoint: ENDPOINT,
            centrifugoUrl: 'ws://localhost:8000/connection/websocket',
            userId: 'persist-tester-' + Math.random().toString(36).substr(2, 5),
            workspaceId: 'test-workspace',
            enablePersistence: true
        });

        const docRef = client.doc('persistence-test/item-1');
        const pre = document.getElementById('docContent');
        const log = document.getElementById('logContent');
        const connStatus = document.getElementById('txtConnectivity');

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.prepend(div);
        }

        // Listen for realtime changes
        docRef.onSnapshot(data => {
            addLog('Realtime update received');
            pre.textContent = JSON.stringify(data, null, 2);
        });

        document.getElementById('btnOnline').onclick = () => {
            client.config.endpoint = ENDPOINT;
            connStatus.textContent = 'ONLINE';
            connStatus.className = 'status online';
            addLog('Switched to online mode');
            client.processQueue();
        };

        document.getElementById('btnOffline').onclick = () => {
            client.config.endpoint = DEAD_ENDPOINT;
            connStatus.textContent = 'OFFLINE';
            connStatus.className = 'status offline';
            addLog('Switched to offline mode');
        };

        document.getElementById('btnIncrement').onclick = async () => {
            const current = await docRef.get() || { count: 0 };
            const next = { count: (current.count || 0) + 1 };

            addLog(`Attempting write: count=${next.count}`);
            try {
                const res = await docRef.set(next);
                if (res.version === -1) {
                    addLog('⚠️ Write queued (Offline)');
                } else {
                    addLog('✅ Write succeeded (Online)');
                }
                // Refresh UI immediately (Optimistic UI)
                const optimisic = await docRef.get();
                pre.textContent = JSON.stringify(optimisic, null, 2);
            } catch (e) {
                addLog('❌ Write failed: ' + e.message);
            }
        };

        document.getElementById('btnRefresh').onclick = async () => {
            addLog('Refreshing from network...');
            try {
                const data = await docRef.get();
                pre.textContent = JSON.stringify(data, null, 2);
                addLog('Fetch successful');
            } catch (e) {
                addLog('Fetch failed (offline fallback active)');
            }
        };

        addLog('SDK Initialized with Persistence');
    </script>
</body>

</html>